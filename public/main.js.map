{"version":3,"file":"main.js","sourceRoot":"","sources":["../src/main.ts"],"names":[],"mappings":"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","sourcesContent":["type WatermarkOptions = {\n  text: string;\n  fontSize: number;\n  fontFamily: string;\n  color: string;\n  rotateDeg: number; // 文字旋转角度\n  repeat: boolean;\n  gapX: number;\n  gapY: number;\n  padding: number;\n  image?: HTMLImageElement | null;\n  imageScale: number; // percentage 100 = 1x\n  imageOpacity: number; // 0..1\n  layoutAngle: number; // 排列倾斜角度\n  watermarkOpacity: number; // 整体水印透明度\n  hardenEnabled: boolean; // 是否开启加固\n  blendMode: GlobalCompositeOperation; // 混合模式\n  jitterEnabled: boolean; // 随机扰动\n  textureEnabled: boolean; // 微纹理\n  textureAlpha: number; // 纹理强度\n  invisibleEnabled: boolean; // 隐形水印\n  hiddenText: string; // 隐形水印内容\n  exportFormat: 'png' | 'jpeg'; // 导出格式\n  jpegQuality: number; // JPEG 质量\n};\n\nconst $ = <T extends HTMLElement = HTMLElement>(selector: string) =>\n  document.querySelector<T>(selector)!;\n\nconst fileInput = $(\"#fileInput\") as HTMLInputElement;\nconst canvas = $(\"#canvas\") as HTMLCanvasElement;\nconst applyBtn = $(\"#applyBtn\") as HTMLButtonElement;\nconst downloadBtn = $(\"#downloadBtn\") as HTMLButtonElement;\nconst resetBtn = $(\"#resetBtn\") as HTMLButtonElement;\n\n// Controls\nconst textInput = $(\"#wmText\") as HTMLInputElement;\nconst fontSizeInput = $(\"#wmFontSize\") as HTMLInputElement;\nconst fontFamilyInput = $(\"#wmFontFamily\") as HTMLInputElement;\nconst colorInput = $(\"#wmColor\") as HTMLInputElement;\nconst rotateInput = $(\"#wmRotate\") as HTMLInputElement;\nconst repeatInput = $(\"#wmRepeat\") as HTMLInputElement;\nconst gapXInput = $(\"#wmGapX\") as HTMLInputElement;\nconst gapYInput = $(\"#wmGapY\") as HTMLInputElement;\nconst paddingInput = $(\"#wmPadding\") as HTMLInputElement;\nconst layoutAngleInput = $(\"#wmLayoutAngle\") as HTMLInputElement;\nconst watermarkOpacityInput = $(\"#wmOpacity\") as HTMLInputElement;\n\nconst wmImageInput = $(\"#wmImageInput\") as HTMLInputElement;\nconst wmImageScaleInput = $(\"#wmImageScale\") as HTMLInputElement;\nconst wmImageOpacityInput = $(\"#wmImageOpacity\") as HTMLInputElement;\n\n// Anti-tamper controls\nconst hardenInput = $(\"#wmHarden\") as HTMLInputElement;\nconst blendSelect = $(\"#wmBlend\") as HTMLSelectElement;\nconst jitterInput = $(\"#wmJitter\") as HTMLInputElement;\nconst textureInput = $(\"#wmTexture\") as HTMLInputElement;\nconst textureAlphaInput = $(\"#wmTextureAlpha\") as HTMLInputElement;\nconst invisibleInput = $(\"#wmInvisible\") as HTMLInputElement;\nconst hiddenTextInput = $(\"#wmHiddenText\") as HTMLInputElement;\nconst exportSelect = $(\"#wmExport\") as HTMLSelectElement;\nconst jpegQInput = $(\"#wmJpegQ\") as HTMLInputElement;\n\nlet baseImage: HTMLImageElement | null = null;\nlet currentOptions: WatermarkOptions = {\n  text: textInput.value,\n  fontSize: Number(fontSizeInput.value),\n  fontFamily: fontFamilyInput.value,\n  color: colorInput.value,\n  rotateDeg: Number(rotateInput.value),\n  repeat: (repeatInput as HTMLInputElement).checked,\n  gapX: Number(gapXInput.value),\n  gapY: Number(gapYInput.value),\n  padding: Number(paddingInput.value),\n  image: null,\n  imageScale: Number(wmImageScaleInput.value),\n  imageOpacity: Number(wmImageOpacityInput.value),\n  layoutAngle: Number(layoutAngleInput?.value || 0),\n  watermarkOpacity: Number(watermarkOpacityInput?.value || 1),\n  hardenEnabled: Boolean(hardenInput?.checked),\n  blendMode: (blendSelect?.value as GlobalCompositeOperation) || 'source-over',\n  jitterEnabled: Boolean(jitterInput?.checked),\n  textureEnabled: Boolean(textureInput?.checked),\n  textureAlpha: Number(textureAlphaInput?.value || 0.06),\n  invisibleEnabled: Boolean(invisibleInput?.checked),\n  hiddenText: hiddenTextInput?.value || 'Watermark',\n  exportFormat: (exportSelect?.value as 'png' | 'jpeg') || 'png',\n  jpegQuality: Number(jpegQInput?.value || 0.9),\n};\n\nfunction readFileAsImage(file: File): Promise<HTMLImageElement> {\n  return new Promise((resolve, reject) => {\n    const reader = new FileReader();\n    reader.onerror = () => reject(reader.error);\n    reader.onload = () => {\n      const img = new Image();\n      img.onload = () => resolve(img);\n      img.onerror = reject;\n      img.src = String(reader.result);\n    };\n    reader.readAsDataURL(file);\n  });\n}\n\nfunction downloadCanvas(canvasEl: HTMLCanvasElement, filename: string) {\n  canvasEl.toBlob((blob) => {\n    if (!blob) return;\n    const url = URL.createObjectURL(blob);\n    const a = document.createElement(\"a\");\n    a.href = url;\n    a.download = filename;\n    document.body.appendChild(a);\n    a.click();\n    a.remove();\n    URL.revokeObjectURL(url);\n  }, \"image/png\");\n}\n\nfunction applyWatermark(\n  base: HTMLImageElement,\n  options: WatermarkOptions,\n  targetCanvas: HTMLCanvasElement\n) {\n  const { width, height } = base;\n  targetCanvas.width = width;\n  targetCanvas.height = height;\n  const ctx = targetCanvas.getContext(\"2d\");\n  if (!ctx) return;\n\n  // draw base image\n  ctx.clearRect(0, 0, width, height);\n  ctx.drawImage(base, 0, 0);\n\n  // Build watermark tile\n  const tileCanvas = document.createElement(\"canvas\");\n  const tileCtx = tileCanvas.getContext(\"2d\")!;\n\n  // Measure text size to decide tile size\n  const font = `${options.fontSize}px ${options.fontFamily}`;\n  tileCtx.font = font;\n  const textMetrics = tileCtx.measureText(options.text);\n  const textW = Math.ceil(\n    Math.max(textMetrics.width, options.image ? (options.image.width * options.imageScale) / 100 : 0)\n  );\n  const textH = Math.ceil(\n    Math.max(options.fontSize, options.image ? (options.image.height * options.imageScale) / 100 : 0)\n  );\n\n  const baseTileW = textW + options.padding * 2 + options.gapX;\n  const baseTileH = textH + options.padding * 2 + options.gapY;\n\n  // Expand tile size for rotation to avoid clipping\n  const angle = (options.rotateDeg * Math.PI) / 180;\n  const cos = Math.abs(Math.cos(angle));\n  const sin = Math.abs(Math.sin(angle));\n  const rotatedW = Math.ceil(baseTileW * cos + baseTileH * sin);\n  const rotatedH = Math.ceil(baseTileW * sin + baseTileH * cos);\n\n  tileCanvas.width = Math.max(1, rotatedW);\n  tileCanvas.height = Math.max(1, rotatedH);\n\n  // Draw watermark within tile centered\n  tileCtx.clearRect(0, 0, tileCanvas.width, tileCanvas.height);\n  tileCtx.save();\n  tileCtx.translate(tileCanvas.width / 2, tileCanvas.height / 2);\n  tileCtx.rotate(angle);\n\n  // text\n  tileCtx.font = font;\n  tileCtx.textAlign = \"center\";\n  tileCtx.textBaseline = \"middle\";\n  tileCtx.fillStyle = options.color;\n  tileCtx.fillText(options.text, 0, 0);\n\n  // image watermark\n  if (options.image) {\n    const scaledW = (options.image.width * options.imageScale) / 100;\n    const scaledH = (options.image.height * options.imageScale) / 100;\n    tileCtx.globalAlpha = options.imageOpacity;\n    tileCtx.drawImage(options.image, -scaledW / 2, -scaledH / 2, scaledW, scaledH);\n    tileCtx.globalAlpha = 1;\n  }\n  tileCtx.restore();\n\n  if (options.repeat) {\n    // 带布局倾斜与可选抖动的铺满\n    ctx.save();\n    ctx.globalAlpha = Math.min(1, Math.max(0, options.watermarkOpacity ?? 1));\n    ctx.globalCompositeOperation = options.hardenEnabled\n      ? (options.blendMode || 'source-over')\n      : 'source-over';\n    ctx.translate(width / 2, height / 2);\n    const layoutRad = ((options.layoutAngle ?? 0) * Math.PI) / 180;\n    ctx.rotate(layoutRad);\n\n    if (options.jitterEnabled) {\n      const stepX = tileCanvas.width;\n      const stepY = tileCanvas.height;\n      const startX = -width / 2 - stepX;\n      const endX = width / 2 + stepX;\n      const startY = -height / 2 - stepY;\n      const endY = height / 2 + stepY;\n      const ampX = Math.max(2, (options.gapX || 0) * 0.25);\n      const ampY = Math.max(2, (options.gapY || 0) * 0.25);\n      for (let y = startY; y <= endY; y += stepY) {\n        for (let x = startX; x <= endX; x += stepX) {\n          const dx = (Math.random() - 0.5) * 2 * ampX;\n          const dy = (Math.random() - 0.5) * 2 * ampY;\n          ctx.drawImage(tileCanvas, x + dx, y + dy);\n        }\n      }\n    } else {\n      const pattern = ctx.createPattern(tileCanvas, 'repeat');\n      if (pattern) {\n        ctx.fillStyle = pattern;\n        ctx.fillRect(-width / 2, -height / 2, width, height);\n      }\n    }\n    ctx.restore();\n  } else {\n    // Single watermark placed at center\n    const posX = width / 2 - tileCanvas.width / 2;\n    const posY = height / 2 - tileCanvas.height / 2;\n    ctx.save();\n    ctx.globalAlpha = Math.min(1, Math.max(0, options.watermarkOpacity ?? 1));\n    ctx.globalCompositeOperation = options.hardenEnabled\n      ? (options.blendMode || 'source-over')\n      : 'source-over';\n    ctx.drawImage(tileCanvas, posX, posY);\n    ctx.restore();\n  }\n\n  // 微纹理覆盖，增加修复难度\n  if (options.hardenEnabled && options.textureEnabled) {\n    ctx.save();\n    const noiseTile = document.createElement('canvas');\n    const n = 128;\n    noiseTile.width = n;\n    noiseTile.height = n;\n    const nctx = noiseTile.getContext('2d')!;\n    const imgData = nctx.createImageData(n, n);\n    for (let i = 0; i < imgData.data.length; i += 4) {\n      const v = Math.floor(Math.random() * 256);\n      imgData.data[i] = v;\n      imgData.data[i + 1] = v;\n      imgData.data[i + 2] = v;\n      imgData.data[i + 3] = 255;\n    }\n    nctx.putImageData(imgData, 0, 0);\n    const noisePattern = ctx.createPattern(noiseTile, 'repeat');\n    if (noisePattern) {\n      ctx.globalAlpha = Math.min(1, Math.max(0, options.textureAlpha ?? 0.06));\n      ctx.globalCompositeOperation = 'overlay';\n      ctx.fillStyle = noisePattern;\n      ctx.fillRect(0, 0, width, height);\n    }\n    ctx.restore();\n  }\n}\n\nfunction refreshOptionsFromInputs(): WatermarkOptions {\n  currentOptions = {\n    text: textInput.value,\n    fontSize: Number(fontSizeInput.value) || 36,\n    fontFamily: fontFamilyInput.value || \"Arial, sans-serif\",\n    color: colorInput.value || \"rgba(255,255,255,0.8)\",\n    rotateDeg: Number(rotateInput.value) || 0,\n    repeat: repeatInput.checked,\n    gapX: Math.max(0, Number(gapXInput.value) || 0),\n    gapY: Math.max(0, Number(gapYInput.value) || 0),\n    padding: Math.max(0, Number(paddingInput.value) || 0),\n    image: currentOptions.image ?? null,\n    imageScale: Math.max(1, Number(wmImageScaleInput.value) || 100),\n    imageOpacity: Math.min(1, Math.max(0, Number(wmImageOpacityInput.value) || 0.6)),\n    layoutAngle: Number(layoutAngleInput?.value || 0),\n    watermarkOpacity: Math.min(1, Math.max(0, Number(watermarkOpacityInput?.value || 1))),\n    hardenEnabled: Boolean(hardenInput?.checked),\n    blendMode: (blendSelect?.value as GlobalCompositeOperation) || 'source-over',\n    jitterEnabled: Boolean(jitterInput?.checked),\n    textureEnabled: Boolean(textureInput?.checked),\n    textureAlpha: Math.min(1, Math.max(0, Number(textureAlphaInput?.value || 0.06))),\n    invisibleEnabled: Boolean(invisibleInput?.checked),\n    hiddenText: hiddenTextInput?.value || 'Watermark',\n    exportFormat: (exportSelect?.value as 'png' | 'jpeg') || 'png',\n    jpegQuality: Math.min(1, Math.max(0, Number(jpegQInput?.value || 0.9))),\n  };\n  return currentOptions;\n}\n\nfunction maybePreview() {\n  if (!baseImage) return;\n  const options = refreshOptionsFromInputs();\n  applyWatermark(baseImage, options, canvas);\n  downloadBtn.disabled = false;\n}\n\n// Events\nfileInput.addEventListener(\"change\", async () => {\n  const file = fileInput.files?.[0];\n  if (!file) return;\n  const img = await readFileAsImage(file);\n  baseImage = img;\n  // Fit canvas visually (CSS handles sizing), we render native size\n  maybePreview();\n});\n\nwmImageInput.addEventListener(\"change\", async () => {\n  const file = wmImageInput.files?.[0];\n  if (!file) {\n    currentOptions.image = null;\n    maybePreview();\n    return;\n  }\n  const img = await readFileAsImage(file);\n  currentOptions.image = img;\n  maybePreview();\n});\n\n// live preview on inputs\n[\n  textInput,\n  fontSizeInput,\n  fontFamilyInput,\n  colorInput,\n  rotateInput,\n  repeatInput,\n  gapXInput,\n  gapYInput,\n  paddingInput,\n  wmImageScaleInput,\n  wmImageOpacityInput,\n  layoutAngleInput,\n  watermarkOpacityInput,\n  hardenInput,\n  blendSelect,\n  jitterInput,\n  textureInput,\n  textureAlphaInput,\n  invisibleInput,\n  hiddenTextInput,\n  exportSelect,\n  jpegQInput,\n].forEach((el) => el && el.addEventListener(\"input\", maybePreview));\n\napplyBtn.addEventListener(\"click\", () => {\n  if (!baseImage) return alert(\"请先选择图片\");\n  maybePreview();\n});\n\nfunction cloneCanvas(src: HTMLCanvasElement): HTMLCanvasElement {\n  const c = document.createElement('canvas');\n  c.width = src.width;\n  c.height = src.height;\n  const cctx = c.getContext('2d')!;\n  cctx.drawImage(src, 0, 0);\n  return c;\n}\n\nfunction embedInvisibleWatermark(dest: HTMLCanvasElement, text: string) {\n  if (!text) return;\n  const dctx = dest.getContext('2d');\n  if (!dctx) return;\n  const { width, height } = dest;\n  const imageData = dctx.getImageData(0, 0, width, height);\n  const data = imageData.data;\n  const encoder = new TextEncoder();\n  const bytes = encoder.encode(text);\n  const payload = new Uint8Array(2 + bytes.length);\n  payload[0] = (bytes.length >> 8) & 0xff;\n  payload[1] = bytes.length & 0xff;\n  payload.set(bytes, 2);\n  const totalBits = payload.length * 8;\n  let bitIndex = 0;\n  for (let i = 0; i < data.length && bitIndex < totalBits; i += 4) {\n    const byteIdx = (bitIndex / 8) | 0;\n    const bitPos = 7 - (bitIndex % 8);\n    const bit = (payload[byteIdx] >> bitPos) & 1;\n    data[i + 2] = (data[i + 2] & 0xfe) | bit; // 写入 B 通道 LSB\n    bitIndex++;\n  }\n  dctx.putImageData(imageData, 0, 0);\n}\n\nfunction downloadWithOptions(viewCanvas: HTMLCanvasElement, options: WatermarkOptions) {\n  const temp = cloneCanvas(viewCanvas);\n  if (options.invisibleEnabled) {\n    embedInvisibleWatermark(temp, options.hiddenText || 'Watermark');\n  }\n  const type = options.exportFormat === 'jpeg' ? 'image/jpeg' : 'image/png';\n  const quality = options.exportFormat === 'jpeg' ? options.jpegQuality : undefined;\n  temp.toBlob((blob) => {\n    if (!blob) return;\n    const url = URL.createObjectURL(blob);\n    const a = document.createElement('a');\n    a.href = url;\n    a.download = `watermark.${options.exportFormat}`;\n    document.body.appendChild(a);\n    a.click();\n    a.remove();\n    URL.revokeObjectURL(url);\n  }, type, quality);\n}\n\ndownloadBtn.addEventListener(\"click\", () => {\n  if (!baseImage) return;\n  const options = refreshOptionsFromInputs();\n  applyWatermark(baseImage, options, canvas);\n  downloadWithOptions(canvas, options);\n});\n\nresetBtn.addEventListener(\"click\", () => {\n  fileInput.value = \"\";\n  wmImageInput.value = \"\";\n  baseImage = null;\n  currentOptions.image = null;\n  canvas.width = 0;\n  canvas.height = 0;\n  downloadBtn.disabled = true;\n});\n\n"]}